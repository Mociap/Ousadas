<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuição de Ônibus</title>
    <link rel="shortcut icon" href="../assets/3.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            color: #333;
            padding-top: 80px;
        }

        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            border-radius: 10px 10px 0 0;
            font-weight: bold;
        }

        .onibus-card {
            background: linear-gradient(45deg, #3d7517, #4a8c20);
            color: white;
        }

        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-voltar {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-voltar:hover {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-50%) scale(1.05);
            color: white;
            text-decoration: none;
        }

        .btn-voltar .material-icons {
            font-size: 24px;
        }

        .sort-btn {
            background: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sort-btn:hover {
            transform: scale(1.2);
        }
        
        .sort-btn:focus {
            outline: none;
            box-shadow: none;
        }
        
        .sort-asc .material-icons {
            transform: rotate(180deg);
        }

        .onibus-badge {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .onibus-1 {
            background-color: #28a745;
            color: white;
        }

        .onibus-2 {
            background-color: #007bff;
            color: white;
        }

        .onibus-3 {
            background-color: #6f42c1;
            color: white;
        }

        .sem-onibus {
            background-color: #dc3545;
            color: white;
        }

        .drag-item {
            cursor: move;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }

        .drag-item:hover {
            background-color: #f8f9fa;
            border-left-color: #28a745;
        }

        .drag-over {
            background-color: #e9ecef;
            border: 2px dashed #6c757d;
        }

        .onibus-container {
            min-height: 100px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }

        .onibus-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .onibus-count {
            background-color: #343a40;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 14px;
        }

        .filtro-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #28a745;
            background-color: #f8f9fa;
        }

        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="header">
        <a href="gestao.html" class="btn-voltar">
            <i class="material-icons">arrow_back</i>
        </a>
        <h2 class="header-title">DISTRIBUIÇÃO DE ÔNIBUS</h2>
    </div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-4">
                <div class="card dashboard-card">
                    <div class="card-body onibus-card text-center">
                        <h5 class="card-title">Total de Participantes</h5>
                        <h2 id="totalParticipantes">0</h2>
                        <h6>Com pagamento confirmado</h6>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Distribuição por Ônibus
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 text-center">
                                <h4>Ônibus 1</h4>
                                <h2 id="totalOnibus1">0</h2>
                                <div class="progress mt-2">
                                    <div id="progressOnibus1" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="col-md-6 text-center">
                                <h4>Ônibus 2</h4>
                                <h2 id="totalOnibus2">0</h2>
                                <div class="progress mt-2">
                                    <div id="progressOnibus2" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="filtro-container">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="filtroNome">Buscar por nome</label>
                                <input type="text" class="form-control" id="filtroNome" placeholder="Digite o nome do participante">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="filtroOnibus">Filtrar por ônibus</label>
                                <select class="form-control" id="filtroOnibus">
                                    <option value="todos">Todos os ônibus</option>
                                    <option value="1">Ônibus 1</option>
                                    <option value="2">Ônibus 2</option>
                                    <option value="sem">Sem ônibus</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="ordenacao">Ordenar por</label>
                                <select class="form-control" id="ordenacao">
                                    <option value="nome">Nome</option>
                                    <option value="idade">Idade</option>
                                    <option value="data">Data de inscrição</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Participantes com Pagamento Confirmado</span>
                        <div>
                            <button class="btn btn-success btn-sm" id="btnSalvarDistribuicao">
                                <i class="material-icons">save</i> Salvar Distribuição
                            </button>
                            <button class="btn btn-primary btn-sm ml-2" id="btnExportarLista">
                                <i class="material-icons">cloud_download</i> Exportar Lista
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="participantesTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>
                                            <div class="d-flex align-items-center">
                                                Nome
                                                <button class="btn btn-sm text-white ml-2 sort-btn" data-sort="nome">
                                                    <i class="material-icons" id="sortIconNome">sort</i>
                                                </button>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="d-flex align-items-center">
                                                Idade
                                                <button class="btn btn-sm text-white ml-2 sort-btn" data-sort="idade">
                                                    <i class="material-icons" id="sortIconIdade">sort</i>
                                                </button>
                                            </div>
                                        </th>
                                        <th>Telefone</th>
                                        <th>Ônibus Atual</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="participantesList">
                                    <!-- Os dados serão carregados dinamicamente do Firebase -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <h4 class="mb-3">Distribuição por Ônibus (Arraste e Solte)</h4>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="onibus-container" id="onibus1Container" ondrop="drop(event, 1)" ondragover="allowDrop(event)">
                    <div class="onibus-title">
                        <span>Ônibus 1</span>
                        <span class="onibus-count" id="onibus1Count">0</span>
                    </div>
                    <div id="onibus1Lista">
                        <!-- Lista de participantes do ônibus 1 -->
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="onibus-container" id="onibus2Container" ondrop="drop(event, 2)" ondragover="allowDrop(event)">
                    <div class="onibus-title">
                        <span>Ônibus 2</span>
                        <span class="onibus-count" id="onibus2Count">0</span>
                    </div>
                    <div id="onibus2Lista">
                        <!-- Lista de participantes do ônibus 2 -->
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Importar Lista de Ônibus
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                            <i class="material-icons upload-icon">cloud_upload</i>
                            <p>Clique ou arraste um arquivo CSV/Excel para importar a distribuição de ônibus</p>
                            <input type="file" id="fileInput" style="display: none" accept=".csv, .xlsx" onchange="handleFileUpload(this.files)">
                        </div>
                                                <div class="text-center">
                            <button class="btn btn-outline-secondary" id="btnDownloadModelo">
                                <i class="material-icons">file_download</i> Baixar Modelo de Planilha
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Atribuição de Ônibus -->
    <div class="modal fade" id="atribuirOnibusModal" tabindex="-1" role="dialog" aria-labelledby="atribuirOnibusModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="atribuirOnibusModalLabel">Atribuir Ônibus</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="atribuirOnibusForm">
                        <input type="hidden" id="participanteId">
                        
                        <div class="form-group">
                            <label for="participanteNome">Participante</label>
                            <input type="text" class="form-control" id="participanteNome" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="onibusNumero">Selecione o Ônibus</label>
                            <select class="form-control" id="onibusNumero" required>
                                <option value="">Selecione...</option>
                                <option value="1">Ônibus 1</option>
                                <option value="2">Ônibus 2</option>
                                <option value="sem">Sem ônibus</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="observacoes">Observações (opcional)</label>
                            <textarea class="form-control" id="observacoes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarAtribuicao">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exportação -->
    <div class="modal fade" id="exportarModal" tabindex="-1" role="dialog" aria-labelledby="exportarModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportarModalLabel">Exportar Lista de Ônibus</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="formatoExportacao">Formato de Exportação</label>
                        <select class="form-control" id="formatoExportacao">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                            <option value="pdf">PDF (.pdf)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="onibusExportar">Ônibus para Exportar</label>
                        <select class="form-control" id="onibusExportar">
                            <option value="todos">Todos os ônibus</option>
                            <option value="1">Apenas Ônibus 1</option>
                            <option value="2">Apenas Ônibus 2</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="incluirContatos">
                        <label class="form-check-label" for="incluirContatos">Incluir informações de contato</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmarExportacao">Exportar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="../firebase/firebaseConfig.js"></script>
        
    <script>
        
        // Variáveis globais
        let todosParticipantes = [];
        let participantesFiltrados = [];
        let sortConfig = {
            field: 'idade',
            direction: 'asc'
        };

        // Capacidade máxima de cada ônibus
        const CAPACIDADE_ONIBUS = 40;

        $(document).ready(function () {
            // Carregar dados iniciais
            carregarParticipantes();

            // Configurar eventos de filtro
            $('#filtroNome').on('input', aplicarFiltros);
            $('#filtroOnibus').on('change', aplicarFiltros);
            $('#ordenacao').on('change', aplicarFiltros);

            // Configurar evento de ordenação
            $('.sort-btn').on('click', function() {
                const sortField = $(this).data('sort');
                
                // Se clicar no mesmo campo, inverte a direção
                if (sortField === sortConfig.field) {
                    sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    // Se clicar em um campo diferente, define o novo campo e direção padrão (asc)
                    sortConfig.field = sortField;
                    sortConfig.direction = 'asc';
                }
                
                // Atualizar ícone
                updateSortIcon();
                
                // Aplicar a ordenação
                aplicarFiltros();
            });

            // Configurar evento para salvar atribuição de ônibus
            $('#salvarAtribuicao').on('click', function() {
                const participanteId = $('#participanteId').val();
                const onibusNumero = $('#onibusNumero').val();
                const observacoes = $('#observacoes').val();
                
                if (!onibusNumero) {
                    alert('Por favor, selecione um ônibus.');
                    return;
                }
                
                // Atualizar o participante no Firestore
                db.collection("Eventos").doc("ComRoca2025").collection("inscricoes").doc(participanteId)
                    .update({
                        onibus: onibusNumero === 'sem' ? null : onibusNumero,
                        observacoesOnibus: observacoes,
                        dataAtualizacaoOnibus: new Date().toISOString()
                    })
                    .then(() => {
                        alert('Ônibus atribuído com sucesso!');
                        $('#atribuirOnibusModal').modal('hide');
                        
                        // Atualizar o participante na lista local
                        const index = todosParticipantes.findIndex(p => p.id === participanteId);
                        if (index !== -1) {
                            todosParticipantes[index].onibus = onibusNumero === 'sem' ? null : onibusNumero;
                            todosParticipantes[index].observacoesOnibus = observacoes;
                        }
                        
                        // Recarregar dados
                        aplicarFiltros();
                        atualizarContadores();
                        atualizarListasOnibus();
                    })
                    .catch((error) => {
                        console.error("Erro ao atribuir ônibus: ", error);
                        alert("Erro ao atribuir ônibus. Tente novamente.");
                    });
            });

            // Configurar evento para salvar toda a distribuição
            $('#btnSalvarDistribuicao').on('click', function() {
                salvarDistribuicao();
            });

            // Configurar evento para exportar lista
            $('#btnExportarLista').on('click', function() {
                $('#exportarModal').modal('show');
            });

            // Configurar evento para confirmar exportação
            $('#confirmarExportacao').on('click', function() {
                exportarLista();
                $('#exportarModal').modal('hide');
            });

            // Configurar evento para baixar modelo de planilha
            $('#btnDownloadModelo').on('click', function() {
                baixarModeloPlanilha();
            });

            // Configurar drag and drop para upload de arquivo
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('border-primary');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('border-primary');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
                
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files);
                }
            });
        });

        function carregarParticipantes() {
            // Buscar participantes com pagamento confirmado
            db.collection("Eventos").doc("ComRoca2025").collection("inscricoes")
                .where("anoevento", "==", "2025")
                .where("statusPagamento", "==", "pago")
                .get()
                .then((querySnapshot) => {
                    todosParticipantes = [];
                    
                    querySnapshot.forEach((doc) => {
                        const participante = doc.data();
                        participante.id = doc.id;
                        todosParticipantes.push(participante);
                    });
                    
                    // Aplicar filtros iniciais
                    aplicarFiltros();
                    
                    // Atualizar contadores
                    atualizarContadores();
                    
                    // Atualizar listas de ônibus
                    atualizarListasOnibus();
                })
                .catch((error) => {
                    console.error("Erro ao carregar participantes:", error);
                    alert("Erro ao carregar participantes. Tente novamente.");
                });
        }

        function aplicarFiltros() {
            const filtroNome = $('#filtroNome').val().toLowerCase();
            const filtroOnibus = $('#filtroOnibus').val();
            
            // Aplicar filtros
            participantesFiltrados = todosParticipantes.filter(participante => {
                // Filtro por nome
                const nomeMatch = participante.nome.toLowerCase().includes(filtroNome);
                
                // Filtro por ônibus
                let onibusMatch = true;
                if (filtroOnibus !== 'todos') {
                    if (filtroOnibus === 'sem') {
                        onibusMatch = !participante.onibus;
                    } else {
                        onibusMatch = participante.onibus === filtroOnibus;
                    }
                }
                
                return nomeMatch && onibusMatch;
            });
            
            // Aplicar ordenação
            participantesFiltrados.sort((a, b) => {
                let valorA, valorB;
                
                // Determinar os valores a comparar com base no campo de ordenação
                switch(sortConfig.field) {
                    case 'nome':
                        valorA = a.nome.toLowerCase();
                        valorB = b.nome.toLowerCase();
                        break;
                    case 'idade':
                        // Usar o campo idade diretamente
                        valorA = parseInt(a.idade || 0);
                        valorB = parseInt(b.idade || 0);
                        break;
                    case 'data':
                        valorA = new Date(a.dataInscricao || 0);
                        valorB = new Date(b.dataInscricao || 0);
                        break;
                    default:
                        valorA = a.nome.toLowerCase();
                        valorB = b.nome.toLowerCase();
                }
                
                // Comparar os valores na direção especificada
                if (sortConfig.direction === 'asc') {
                    return valorA > valorB ? 1 : -1;
                } else {
                    return valorA < valorB ? 1 : -1;
                }
            });
            
            // Atualizar a tabela
            atualizarTabelaParticipantes();
        }

        function atualizarTabelaParticipantes() {
            const tabelaParticipantes = $('#participantesList');
            tabelaParticipantes.html('');
            
            if (participantesFiltrados.length === 0) {
                tabelaParticipantes.html('<tr><td colspan="5" class="text-center">Nenhum participante encontrado</td></tr>');
                return;
            }
            
            participantesFiltrados.forEach(participante => {
                // Usar o campo idade diretamente sem adicionar "anos"
                const idade = participante.idade || '';
                const telefone = formatarTelefone(participante.telefone);
                
                // Determinar a classe do badge de ônibus
                let onibusClass = 'sem-onibus';
                let onibusText = 'Sem ônibus';
                
                if (participante.onibus) {
                    onibusClass = `onibus-${participante.onibus}`;
                    onibusText = `Ônibus ${participante.onibus}`;
                }
                
                const linha = `
                <tr class="drag-item" draggable="true" ondragstart="drag(event, '${participante.id}')" id="participante-${participante.id}">
                    <td>${participante.nome}</td>
                    <td>${idade}</td>
                    <td>${telefone}</td>
                    <td><span class="badge onibus-badge ${onibusClass}">${onibusText}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="prepararAtribuicao('${participante.id}')">
                            <i class="material-icons">directions_bus</i>
                        </button>
                    </td>
                </tr>
                `;
                
                tabelaParticipantes.append(linha);
            });
        }

        function atualizarContadores() {
            // Total de participantes com pagamento confirmado
            $('#totalParticipantes').text(todosParticipantes.length);
            
            // Contar participantes por ônibus
            const contagem = {
                onibus1: 0,
                onibus2: 0
            };
            
            todosParticipantes.forEach(participante => {
                if (participante.onibus === '1') contagem.onibus1++;
                if (participante.onibus === '2') contagem.onibus2++;
            });
            
            // Atualizar contadores
            $('#totalOnibus1').text(contagem.onibus1);
            $('#totalOnibus2').text(contagem.onibus2);
            
            // Atualizar barras de progresso
            const porcentagem1 = (contagem.onibus1 / CAPACIDADE_ONIBUS) * 100;
            const porcentagem2 = (contagem.onibus2 / CAPACIDADE_ONIBUS) * 100;
            
            $('#progressOnibus1').css('width', `${porcentagem1}%`);
            $('#progressOnibus2').css('width', `${porcentagem2}%`);
            
            // Atualizar contadores nas listas de ônibus
            $('#onibus1Count').text(contagem.onibus1);
            $('#onibus2Count').text(contagem.onibus2);
            
            // Mudar cor da barra de progresso se estiver próximo da capacidade
            if (porcentagem1 > 90) $('#progressOnibus1').removeClass('bg-success').addClass('bg-danger');
            else $('#progressOnibus1').removeClass('bg-danger').addClass('bg-success');
            
            if (porcentagem2 > 90) $('#progressOnibus2').removeClass('bg-primary').addClass('bg-danger');
            else $('#progressOnibus2').removeClass('bg-danger').addClass('bg-primary');
        }

        function atualizarListasOnibus() {
            // Limpar listas
            $('#onibus1Lista').html('');
            $('#onibus2Lista').html('');
            
            // Filtrar participantes por ônibus
            const onibus1 = todosParticipantes.filter(p => p.onibus === '1');
            const onibus2 = todosParticipantes.filter(p => p.onibus === '2');
            
            // Ordenar por nome
            onibus1.sort((a, b) => a.nome.localeCompare(b.nome));
            onibus2.sort((a, b) => a.nome.localeCompare(b.nome));
            
            // Adicionar participantes às listas
            onibus1.forEach(p => {
                $('#onibus1Lista').append(`
                    <div class="card mb-2 drag-item" draggable="true" ondragstart="drag(event, '${p.id}')" id="onibus-item-${p.id}">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${p.nome}</span>
                                <button class="btn btn-sm btn-outline-danger" onclick="removerDoOnibus('${p.id}')">
                                    <i class="material-icons" style="font-size: 16px;">clear</i>
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            });
            
            onibus2.forEach(p => {
                $('#onibus2Lista').append(`
                    <div class="card mb-2 drag-item" draggable="true" ondragstart="drag(event, '${p.id}')" id="onibus-item-${p.id}">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${p.nome}</span>
                                <button class="btn btn-sm btn-outline-danger" onclick="removerDoOnibus('${p.id}')">
                                    <i class="material-icons" style="font-size: 16px;">clear</i>
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        function prepararAtribuicao(participanteId) {
            const participante = todosParticipantes.find(p => p.id === participanteId);
            
            if (!participante) {
                alert('Participante não encontrado!');
                return;
            }
            
            // Preencher o formulário com os dados do participante
            $('#participanteId').val(participanteId);
            $('#participanteNome').val(participante.nome);
            $('#onibusNumero').val(participante.onibus || '');
            $('#observacoes').val(participante.observacoesOnibus || '');
            
            // Abrir o modal
            $('#atribuirOnibusModal').modal('show');
        }

        function removerDoOnibus(participanteId) {
            if (confirm('Tem certeza que deseja remover este participante do ônibus?')) {
                // Atualizar o participante no Firestore
                db.collection("Eventos").doc("ComRoca2025").collection("inscricoes").doc(participanteId)
                    .update({
                        onibus: null,
                        observacoesOnibus: null,
                        dataAtualizacaoOnibus: new Date().toISOString()
                    })
                    .then(() => {
                        // Atualizar o participante na lista local
                        const index = todosParticipantes.findIndex(p => p.id === participanteId);
                        if (index !== -1) {
                            todosParticipantes[index].onibus = null;
                            todosParticipantes[index].observacoesOnibus = null;
                        }
                        
                        // Recarregar dados
                        aplicarFiltros();
                        atualizarContadores();
                        atualizarListasOnibus();
                    })
                    .catch((error) => {
                        console.error("Erro ao remover do ônibus: ", error);
                        alert("Erro ao remover do ônibus. Tente novamente.");
                    });
            }
        }

        function salvarDistribuicao() {
            // Criar um lote de operações para atualizar todos os participantes de uma vez
            const batch = db.batch();
            
            // Contador para verificar quantos participantes serão atualizados
            let contadorAtualizacoes = 0;
            
            // Iterar sobre todos os participantes
            todosParticipantes.forEach(participante => {
                const ref = db.collection("Eventos").doc("ComRoca2025").collection("inscricoes").doc(participante.id);
                
                // Adicionar operação ao lote
                batch.update(ref, {
                    onibus: participante.onibus,
                    observacoesOnibus: participante.observacoesOnibus,
                    dataAtualizacaoOnibus: new Date().toISOString()
                });
                
                contadorAtualizacoes++;
            });
            
            // Executar o lote de operações
            if (contadorAtualizacoes > 0) {
                batch.commit()
                    .then(() => {
                        alert(`Distribuição de ônibus salva com sucesso! ${contadorAtualizacoes} participantes atualizados.`);
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar distribuição: ", error);
                        alert("Erro ao salvar distribuição. Tente novamente.");
                    });
            } else {
                alert("Nenhuma alteração para salvar.");
            }
        }

        function exportarLista() {
            const formato = $('#formatoExportacao').val();
            const onibusExportar = $('#onibusExportar').val();
            const incluirContatos = $('#incluirContatos').is(':checked');
            
            // Filtrar participantes pelo ônibus selecionado
            let participantesExportar = [...todosParticipantes];
            
            if (onibusExportar !== 'todos') {
                participantesExportar = participantesExportar.filter(p => p.onibus === onibusExportar);
            }
            
            // Ordenar por ônibus e depois por nome
            participantesExportar.sort((a, b) => {
                if (a.onibus !== b.onibus) {
                    // Se um tem ônibus e outro não, o com ônibus vem primeiro
                    if (!a.onibus) return 1;
                    if (!b.onibus) return -1;
                    // Ambos têm ônibus, ordenar por número
                    return a.onibus.localeCompare(b.onibus);
                }
                // Mesmo ônibus, ordenar por nome
                return a.nome.localeCompare(b.nome);
            });
            
            // Preparar dados para exportação
            const dados = participantesExportar.map(p => {
                const item = {
                    'Nome': p.nome,
                    'Idade': p.idade || '',  // Sem adicionar "anos"
                    'Ônibus': p.onibus ? `Ônibus ${p.onibus}` : 'Sem ônibus',
                    'Observações': p.observacoesOnibus || ''
                };
                
                // Adicionar informações de contato se solicitado
                if (incluirContatos) {
                    item['Telefone'] = formatarTelefone(p.telefone);
                    item['Email'] = p.email || '';
                    item['Responsável'] = p.nomeResponsavel || '';
                    item['Telefone Responsável'] = formatarTelefone(p.telefoneResponsavel);
                }
                
                return item;
            });
            
            // Exportar no formato selecionado
            switch (formato) {
                case 'excel':
                    exportarExcel(dados);
                    break;
                case 'csv':
                    exportarCSV(dados);
                    break;
                case 'pdf':
                    exportarPDF(dados);
                    break;
            }
        }

        function exportarExcel(dados) {
            // Criar uma planilha
            const ws = XLSX.utils.json_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Distribuição de Ônibus");
            
            // Gerar arquivo Excel
            const nomeArquivo = `Distribuicao_Onibus_AcampBT2025_${formatarDataArquivo(new Date())}.xlsx`;
            XLSX.writeFile(wb, nomeArquivo);
        }

        function exportarCSV(dados) {
            // Converter dados para CSV
            const ws = XLSX.utils.json_to_sheet(dados);
            const csv = XLSX.utils.sheet_to_csv(ws);
            
            // Criar blob e download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const nomeArquivo = `Distribuicao_Onibus_AcampBT2025_${formatarDataArquivo(new Date())}.csv`;
            saveAs(blob, nomeArquivo);
        }

        function exportarPDF(dados) {
            alert("Exportação para PDF não implementada. Por favor, escolha Excel ou CSV.");
            // A implementação de PDF requer bibliotecas adicionais como jsPDF
        }

        function baixarModeloPlanilha() {
            // Criar modelo de planilha
            const modelo = [
                {
                    'ID': 'ID do participante (não alterar)',
                    'Nome': 'Nome do participante',
                    'Ônibus': '1, 2 ou deixe em branco para remover',
                    'Observações': 'Observações sobre o participante'
                }
            ];
            
            // Criar uma planilha
            const ws = XLSX.utils.json_to_sheet(modelo);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Modelo");
            
            // Gerar arquivo Excel
            const nomeArquivo = `Modelo_Distribuicao_Onibus_AcampBT2025.xlsx`;
            XLSX.writeFile(wb, nomeArquivo);
        }

        function handleFileUpload(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Obter a primeira planilha
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Converter para JSON
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        alert("Arquivo vazio ou formato inválido.");
                        return;
                    }
                    
                    // Verificar se o arquivo tem o formato esperado
                    if (!jsonData[0].hasOwnProperty('ID') || !jsonData[0].hasOwnProperty('Ônibus')) {
                        alert("Formato de arquivo inválido. Use o modelo fornecido.");
                        return;
                    }
                    
                    // Confirmar importação
                    if (confirm(`Deseja importar ${jsonData.length} registros de distribuição de ônibus?`)) {
                        processarImportacao(jsonData);
                    }
                } catch (error) {
                    console.error("Erro ao processar arquivo:", error);
                    alert("Erro ao processar arquivo. Verifique o formato e tente novamente.");
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processarImportacao(dados) {
            // Criar um lote de operações para atualizar todos os participantes de uma vez
            const batch = db.batch();
            
            // Contador para verificar quantos participantes serão atualizados
            let contadorAtualizacoes = 0;
            let contadorErros = 0;
            
            // Iterar sobre os dados importados
            dados.forEach(item => {
                // Verificar se o ID é válido
                if (!item.ID) {
                    contadorErros++;
                    return;
                }
                
                const participanteId = item.ID.toString();
                const onibus = item['Ônibus'] ? item['Ônibus'].toString() : null;
                const observacoes = item['Observações'] || '';
                
                // Verificar se o ônibus é válido (1, 2 ou null)
                if (onibus && !['1', '2'].includes(onibus)) {
                    contadorErros++;
                    return;
                }
                
                // Adicionar operação ao lote
                const ref = db.collection("Eventos").doc("ComRoca2025").collection("inscricoes").doc(participanteId);
                batch.update(ref, {
                    onibus: onibus,
                    observacoesOnibus: observacoes,
                    dataAtualizacaoOnibus: new Date().toISOString()
                });
                
                contadorAtualizacoes++;
            });
            
            // Executar o lote de operações
            if (contadorAtualizacoes > 0) {
                batch.commit()
                    .then(() => {
                        alert(`Importação concluída com sucesso!\n${contadorAtualizacoes} participantes atualizados.\n${contadorErros} registros com erro.`);
                        
                        // Recarregar dados
                        carregarParticipantes();
                    })
                    .catch((error) => {
                        console.error("Erro ao importar dados: ", error);
                        alert("Erro ao importar dados. Tente novamente.");
                    });
            } else {
                alert(`Nenhum participante válido para atualizar.\n${contadorErros} registros com erro.`);
            }
        }

        function formatarTelefone(telefone) {
            if (!telefone) return '';
            
            // Remover caracteres não numéricos
            const numeros = telefone.replace(/\D/g, '');
            
            // Formatar como (XX) XXXXX-XXXX ou (XX) XXXX-XXXX
            if (numeros.length === 11) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 7)}-${numeros.substring(7)}`;
            } else if (numeros.length === 10) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 6)}-${numeros.substring(6)}`;
            }
            
            return telefone;
        }

        function formatarDataArquivo(data) {
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');
            
            return `${dia}-${mes}-${ano}_${hora}-${minuto}`;
        }

        function updateSortIcon() {
            // Remover classes de todos os ícones
            $('.sort-btn').removeClass('sort-asc sort-desc');
            
            // Adicionar classe ao ícone atual
            $(`.sort-btn[data-sort="${sortConfig.field}"]`).addClass(
                sortConfig.direction === 'asc' ? 'sort-asc' : 'sort-desc'
            );
        }

        // Funções para drag and drop
        function drag(event, participanteId) {
            event.dataTransfer.setData("participanteId", participanteId);
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function drop(event, onibusNumero) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const participanteId = event.dataTransfer.getData("participanteId");
            
            // Verificar capacidade do ônibus
            const contagem = {
                '1': parseInt($('#onibus1Count').text()),
                '2': parseInt($('#onibus2Count').text())
            };
            
            // Se o participante já está em um ônibus, não contar ele na verificação de capacidade
            const participante = todosParticipantes.find(p => p.id === participanteId);
            if (participante && participante.onibus === onibusNumero.toString()) {
                // Já está no mesmo ônibus, não fazer nada
                return;
            }
            
            if (participante && participante.onibus) {
                contagem[participante.onibus]--;
            }
            
            // Verificar se o ônibus já está na capacidade máxima
            if (contagem[onibusNumero] >= CAPACIDADE_ONIBUS) {
                alert(`O Ônibus ${onibusNumero} já atingiu a capacidade máxima de ${CAPACIDADE_ONIBUS} participantes.`);
                return;
            }
            
            // Atualizar o participante no Firestore
            db.collection("Eventos").doc("ComRoca2025").collection("inscricoes").doc(participanteId)
                .update({
                    onibus: onibusNumero.toString(),
                    dataAtualizacaoOnibus: new Date().toISOString()
                })
                .then(() => {
                    // Atualizar o participante na lista local
                    const index = todosParticipantes.findIndex(p => p.id === participanteId);
                    if (index !== -1) {
                        todosParticipantes[index].onibus = onibusNumero.toString();
                    }
                    
                    // Recarregar dados
                    aplicarFiltros();
                    atualizarContadores();
                    atualizarListasOnibus();
                })
                .catch((error) => {
                    console.error("Erro ao atribuir ônibus: ", error);
                    alert("Erro ao atribuir ônibus. Tente novamente.");
                });
        }

        // Adicionar event listeners para drag and drop nos containers de ônibus
        document.addEventListener('DOMContentLoaded', function() {
            const containers = document.querySelectorAll('.onibus-container');
            
            containers.forEach(container => {
                container.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                container.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                container.addEventListener('drop', function(e) {
                    this.classList.remove('drag-over');
                });
            });
        });
    </script>
</body>

</html>
<link rel="stylesheet" href="../css/common.css">