<!DOCTYPE html>
<html lang="pt-br">
<!-- Excluir Checkin -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Check-ins</title>
    <link rel="shortcut icon" href="../assets/3.ico" type="image/x-icon">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            color: #333;
            padding-top: 80px;
        }

        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            border-radius: 10px 10px 0 0;
            font-weight: bold;
        }

        .total-card {
            background: linear-gradient(45deg, #3d7517, #4a8c20);
            color: white;
        }

        .checkin-card {
            background: linear-gradient(45deg, #6108a1, #9900CC);
            color: white;
        }

        .pendente-card {
            background: linear-gradient(45deg, #e6a800, #ddb945);
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .checkin-action {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .badge-realizado {
            background-color: #4a8c20;
            color: white;
        }

        .badge-pendente {
            background-color: #ffc107;
        }

        .btn-voltar {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-voltar:hover {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-50%) scale(1.05);
            color: white;
            text-decoration: none;
        }

        .btn-voltar .material-icons {
            font-size: 24px;
        }

        .btn-pdf {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-pdf:hover {
            transform: scale(1.2);
        }

        .btn-pdf .material-icons {
            font-size: 20px;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background-color: #6108a1;
            color: white;
            border-color: #6108a1;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #bd2130;
        }

        .spinner-border {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div class="header">
        <a href="gestao.html" class="btn-voltar">
            <i class="material-icons">arrow_back</i>
        </a>
        <h2 class="header-title">GERENCIAMENTO DE CHECK-INS</h2>
    </div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-4">
                <div class="card dashboard-card">
                    <div class="card-body total-card text-center">
                        <h5 class="card-title">Total de Pagamentos</h5>
                        <h2 id="totalInscritos">0</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card dashboard-card">
                    <div class="card-body checkin-card text-center">
                        <h5 class="card-title">Check-ins Realizados</h5>
                        <h2 id="totalCheckins">0</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card dashboard-card">
                    <div class="card-body pendente-card text-center">
                        <h5 class="card-title">Check-ins Pendentes</h5>
                        <h2 id="totalPendentes">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Status de Check-ins
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="graficoStatus"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Check-ins por Dia
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="graficoDias"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Gerenciamento de Check-ins
                    </div>
                    <div class="card-body">
                        <div class="search-container">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput"
                                    placeholder="Buscar por nome...">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                        <i class="material-icons">search</i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="filter-container">
                            <button class="btn btn-outline-secondary filter-btn active"
                                data-filter="todos">Todos</button>
                            <button class="btn btn-outline-secondary filter-btn"
                                data-filter="realizados">Realizados</button>
                            <button class="btn btn-outline-secondary filter-btn"
                                data-filter="pendentes">Pendentes</button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped" id="checkinsTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Acampante</th>
                                        <th>Data de Check-in</th>
                                        <th>Responsável</th>
                                        <th>Telefone</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="checkinsList">
                                    <!-- Os dados serão carregados dinamicamente do Firebase -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Check-in -->
    <div class="modal fade" id="detalhesModal" tabindex="-1" role="dialog" aria-labelledby="detalhesModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalhesModalLabel">Detalhes do Check-in</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body" id="detalhesModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="exportarPDF">Exportar PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="confirmarExclusaoModal" tabindex="-1" role="dialog" aria-labelledby="confirmarExclusaoModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmarExclusaoModalLabel">Confirmar Exclusão</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o check-in de <strong id="nomeAcampanteExclusao"></strong>?</p>
                    <p class="text-danger">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarExclusaoBtn">Excluir Check-in</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="../firebase/firebaseConfig.js"></script>
    
    <script>
        
        // Variáveis para gráficos
        let graficoStatus;
        let graficoDias;
        let todosAcampantes = [];
        let filtroAtual = 'todos';

        $(document).ready(function () {
            // Carregar dados
            carregarDashboard();
            carregarCheckins();

            // Inicializar gráficos
            initGraficos();

            // Configurar busca
            $('#searchButton').on('click', function () {
                const searchTerm = $('#searchInput').val().toLowerCase();
                filtrarAcampantes(searchTerm, filtroAtual);
            });

            $('#searchInput').on('keyup', function (e) {
                if (e.key === 'Enter') {
                    const searchTerm = $(this).val().toLowerCase();
                    filtrarAcampantes(searchTerm, filtroAtual);
                }
            });

            // Configurar filtros
            $('.filter-btn').on('click', function () {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                filtroAtual = $(this).data('filter');
                const searchTerm = $('#searchInput').val().toLowerCase();
                filtrarAcampantes(searchTerm, filtroAtual);
            });

            // Exportar PDF
            $('#exportarPDF').on('click', function () {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const modalBody = document.getElementById('detalhesModalBody');

                // Capturar o conteúdo como imagem (incluindo a assinatura que já está no modal)
                html2canvas(modalBody).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190;
                    const pageHeight = 290;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 10;

                    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // Adicionar páginas adicionais se necessário
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // Salvar o PDF
                    const acampanteNome = $('#detalhesModalLabel').text().replace('Detalhes do Check-in: ', '');
                    doc.save(`Checkin_${acampanteNome.replace(/\s+/g, '_')}.pdf`);
                });
            });
        });

        function carregarDashboard() {
            // Buscar todas as inscrições com status de pagamento "pago"
            db.collection("Eventos").doc("ComRoca2025").collection("inscricoes")
                .where("anoevento", "==", "2025")
                .where("statusPagamento", "==", "pago")
                .get()
                .then((querySnapshot) => {
                    let totalPagos = querySnapshot.size;
                    let totalCheckins = 0;
                    let totalPendentes = 0;

                    querySnapshot.forEach((doc) => {
                        const acampante = doc.data();
                        if (acampante.statusCheckin === 'realizado') {
                            totalCheckins++;
                        } else {
                            totalPendentes++;
                        }
                    });

                    // Atualizar contadores
                    $('#totalInscritos').text(totalPagos);
                    $('#totalCheckins').text(totalCheckins);
                    $('#totalPendentes').text(totalPendentes);

                    // Atualizar gráfico de status
                    atualizarGraficoStatus(totalCheckins, totalPendentes);

                    // Buscar datas de check-in para o gráfico por dia
                    buscarDatasCheckin();
                })
                .catch((error) => {
                    console.error("Erro ao carregar dashboard: ", error);
                });
        }

        function buscarDatasCheckin() {
            // Buscar check-ins realizados
            db.collection("Eventos").doc("ComRoca2025").collection("checkin")
                .get()
                .then((querySnapshot) => {
                    const datasPorDia = {};

                    querySnapshot.forEach((doc) => {
                        const checkin = doc.data();
                        if (checkin.dtCheckin) {
                            const data = new Date(checkin.dtCheckin);
                            const dataFormatada = data.toLocaleDateString('pt-BR');

                            if (datasPorDia[dataFormatada]) {
                                datasPorDia[dataFormatada]++;
                            } else {
                                datasPorDia[dataFormatada] = 1;
                            }
                        }
                    });

                    // Atualizar gráfico de datas
                    atualizarGraficoDias(datasPorDia);
                })
                .catch((error) => {
                    console.error("Erro ao buscar datas de check-in: ", error);
                });
        }

        function carregarCheckins() {
            // Limpar tabela de check-ins
            const tabelaCheckins = $('#checkinsList');
            tabelaCheckins.html('');

            // Buscar todos os acampantes
            db.collection("Eventos").doc("ComRoca2025").collection("inscricoes")
                .where("anoevento", "==", "2025")
                .orderBy("nome")
                .get()
                .then((querySnapshot) => {
                    todosAcampantes = [];

                    querySnapshot.forEach((doc) => {
                        const acampante = doc.data();
                        acampante.id = doc.id;
                        todosAcampantes.push(acampante);
                    });

                    // Exibir acampantes na tabela
                    exibirAcampantes(todosAcampantes);
                })
                .catch((error) => {
                    console.error("Erro ao carregar acampantes: ", error);
                });
        }

        function exibirAcampantes(acampantes) {
            const tabelaCheckins = $('#checkinsList');
            tabelaCheckins.html('');

            acampantes.forEach((acampante) => {
                const dataCheckin = acampante.dtCheckin ? formatarData(acampante.dtCheckin) : '-';
                const statusCheckin = acampante.statusCheckin === 'realizado' ?
                    '<span class="badge badge-realizado">Realizado</span>' :
                    '<span class="badge badge-pendente">Pendente</span>';

                const linha = `
                    <tr>
                        <td>${acampante.nome}</td>
                        <td>${dataCheckin}</td>
                        <td>${acampante.contato || '-'}</td>
                        <td>${acampante.celular || '-'}</td>
                        <td>${statusCheckin}</td>
                        <td>
                            ${acampante.statusCheckin === 'realizado' ?
                        `<button class="btn btn-info btn-sm mr-2" onclick="verDetalhes('${acampante.nome}')">
                                    <i class="material-icons">visibility</i>
                                </button>
                                <button class="btn btn-pdf mr-2" onclick="exportarPDF('${acampante.nome}')">
                                    <i class="material-icons">picture_as_pdf</i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmarExclusao('${acampante.nome}')">
                                    <i class="material-icons">delete</i>
                                </button>` :
                        `<button class="btn btn-primary btn-sm" onclick="realizarCheckin('${acampante.nome}')">
                                    <i class="material-icons">how_to_reg</i>
                                </button>`
                    }
                        </td>
                    </tr>
                `;

                tabelaCheckins.append(linha);
            });
        }

        function filtrarAcampantes(termo, filtro) {
            let acampantesFiltrados = todosAcampantes;

            // Aplicar filtro de status
            if (filtro === 'realizados') {
                acampantesFiltrados = acampantesFiltrados.filter(a => a.statusCheckin === 'realizado');
            } else if (filtro === 'pendentes') {
                acampantesFiltrados = acampantesFiltrados.filter(a => a.statusCheckin !== 'realizado');
            }

            // Aplicar filtro de busca
            if (termo) {
                acampantesFiltrados = acampantesFiltrados.filter(a =>
                    a.nome.toLowerCase().includes(termo) ||
                    (a.contato && a.contato.toLowerCase().includes(termo))
                );
            }

            exibirAcampantes(acampantesFiltrados);
        }

        function verDetalhes(nomeAcampante) {
            // Buscar detalhes do check-in
            db.collection("Eventos").doc("ComRoca2025").collection("checkin")
                .where("nome", "==", nomeAcampante)
                .limit(1)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        const checkin = querySnapshot.docs[0].data();

                        // Atualizar título do modal
                        $('#detalhesModalLabel').text(`Detalhes do Check-in: ${checkin.nome}`);

                        // Construir conteúdo do modal
                        let conteudo = `
                            <div class="container-fluid">
                                <div class="row mb-3">
                                    <div class="col-12 mb-4">
                                        <div style="display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;">
                                            <img src="../assets/Logo.png" alt="Logo ACAMP" style="height: 50px; margin-right: 15px;">
                                            <h4 style="margin-bottom: 0;">Ficha de Check-in - ACAMP IEBI 2025</h4>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <h5 class="border-bottom pb-2">Dados Pessoais</h5>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Nome:</strong> ${checkin.nome}</p>
                                        <p><strong>Data de Nascimento:</strong> ${formatarDataSimples(checkin.dtnasc)}</p>
                                        <p><strong>Idade:</strong> ${checkin.idade}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>CPF:</strong> ${checkin.cpf || '-'}</p>
                                        <p><strong>Responsável:</strong> ${checkin.responsavel || '-'}</p>
                                        <p><strong>Telefone:</strong> ${checkin.telefone1 || '-'}</p>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h5 class="border-bottom pb-2">Saúde</h5>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Alergias Alimentares:</strong> ${checkin.alergiasAlimentares === 'sim' ? 'Sim' : 'Não'}</p>
                                        ${checkin.alergiasAlimentares === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisAlergiasAlimentares}</p>` : ''}
                                        
                                        <p><strong>Alergias a Medicamentos:</strong> ${checkin.alergiasMedicamentos === 'sim' ? 'Sim' : 'Não'}</p>
                                        ${checkin.alergiasMedicamentos === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisAlergiasMedicamentos}</p>` : ''}
                                        
                                        <p><strong>Alergias a Insetos:</strong> ${checkin.alergiasInsetos === 'sim' ? 'Sim' : 'Não'}</p>
                                        ${checkin.alergiasInsetos === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisAlergiasInsetos}</p>` : ''}
                                        
                                        <p><strong>Possui Seguro Saúde:</strong> ${checkin.seguroSaude ? 'Sim' : 'Não'}</p>
                                        ${checkin.seguroSaude ? `<p><strong>Qual:</strong> ${checkin.seguroSaude}</p>` : ''}
                                        
                                        <p><strong>Hospital de Preferência:</strong> ${checkin.hospitalPreferencia || 'Não informado'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Medicamentos Controlados:</strong> ${checkin.medicamentosControlados === 'sim' ? 'Sim' : 'Não'}</p>
                                        ${checkin.medicamentosControlados === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisMedicamentos}</p>` : ''}
                                        
                                        <p><strong>Problemas de Saúde:</strong> ${checkin.problemasSaude === 'sim' ? 'Sim' : 'Não'}</p>
                                        ${checkin.problemasSaude === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisProblemasSaude}</p>` : ''}
                                        
                                        <p><strong>Tipo Sanguíneo:</strong> ${checkin.tipoSanguineo || 'Não informado'}</p>
                                        <p><strong>Vacinas em Dia:</strong> ${checkin.vacinasEmDia === 'sim' ? 'Sim' : 'Não'}</p>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h5 class="border-bottom pb-2">Alimentação</h5>
                                    </div>
                                    <div class="col-12">
                                        <p><strong>Restrições Alimentares:</strong> ${checkin.restricoesAlimentares === 'sim' ? 'Sim' : 'Não'}</p>
                                        ${checkin.restricoesAlimentares === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisRestricoesAlimentares}</p>` : ''}
                                        
                                        <p><strong>Alimentos que não consome:</strong> ${checkin.alimentosNaoConsome || 'Nenhum'}</p>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h5 class="border-bottom pb-2">Outros</h5>
                                    </div>
                                    <div class="col-12">
                                        <p><strong>Comportamento Especial:</strong> ${checkin.comportamentoEspecial === 'sim' ? 'Sim' : 'Não'}</p>
                                        ${checkin.comportamentoEspecial === 'sim' ? `<p><strong>Qual:</strong> ${checkin.qualComportamento}</p>` : ''}
                                        
                                        <p><strong>Observações:</strong> ${checkin.observacoesAdicionais || 'Nenhuma'}</p>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h5 class="border-bottom pb-2">Autorizações</h5>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Participação:</strong> ${checkin.autorizacaoParticipacao ? 'Autorizado' : 'Não autorizado'}</p>
                                        <p><strong>Atendimento Médico:</strong> ${checkin.autorizacaoEmergencia ? 'Autorizado' : 'Não autorizado'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Uso de Imagem:</strong> ${checkin.autorizacaoFotos ? 'Autorizado' : 'Não autorizado'}</p>
                                        <p><strong>Medicamentos Básicos:</strong> ${checkin.autorizacaoMedicamentos ? 'Autorizado' : 'Não autorizado'}</p>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-12">
                                        <h5 class="border-bottom pb-2">Assinatura</h5>
                                    </div>
                                    <div class="col-12 text-center">
                                        ${checkin.assinatura ?
                                `<img id="assinaturaImg" src="${checkin.assinatura}" alt="Assinatura" style="max-width: 50%; max-height: 100px;">` :
                                '<p>Assinatura não disponível</p>'}
                                    </div>
                                </div>
                            </div>
                        `;

                        // Atualizar conteúdo do modal
                        $('#detalhesModalBody').html(conteudo);

                        // Exibir modal
                        $('#detalhesModal').modal('show');
                    } else {
                        alert('Detalhes do check-in não encontrados.');
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar detalhes do check-in: ", error);
                    alert('Erro ao buscar detalhes do check-in.');
                });
        }

        function realizarCheckin(nomeAcampante) {
            // Redirecionar para a página de check-in com o nome do acampante como parâmetro
            window.location.href = `frmcheckinACAMP.html?nome=${encodeURIComponent(nomeAcampante)}`;
        }

        function exportarPDF(nomeAcampante) {
            // Buscar detalhes do check-in
            db.collection("Eventos").doc("ComRoca2025").collection("checkin")
                .where("nome", "==", nomeAcampante)
                .limit(1)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        const checkin = querySnapshot.docs[0].data();

                        // Criar o mesmo HTML que é usado no modal
                        let conteudoHTML = `
                    <div class="container-fluid" style="font-family: 'Montserrat', sans-serif; color: #333; max-width: 800px; margin: 0 auto; padding: 20px;">
                        <div class="row mb-3">
                            <div class="col-12 mb-4">
                                <div style="display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;">
                                    <img src="../assets/Logo.png" alt="Logo ACAMP" style="height: 50px; margin-right: 15px;">
                                    <h4 style="margin-bottom: 0;">Ficha de Check-in - ACAMP IEBI 2025</h4>
                                </div>
                            </div>
                            <div class="col-12">
                                <h5 style="border-bottom: 1px solid #dee2e6; padding-bottom: 8px;">Dados Pessoais</h5>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Nome:</strong> ${checkin.nome}</p>
                                <p><strong>Data de Nascimento:</strong> ${formatarDataSimples(checkin.dtnasc)}</p>
                                <p><strong>Idade:</strong> ${checkin.idade}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>CPF:</strong> ${checkin.cpf || '-'}</p>
                                <p><strong>Responsável:</strong> ${checkin.responsavel || '-'}</p>
                                <p><strong>Telefone:</strong> ${checkin.telefone1 || '-'}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <h5 style="border-bottom: 1px solid #dee2e6; padding-bottom: 8px;">Saúde</h5>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Alergias Alimentares:</strong> ${checkin.alergiasAlimentares === 'sim' ? 'Sim' : 'Não'}</p>
                                ${checkin.alergiasAlimentares === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisAlergiasAlimentares}</p>` : ''}
                                
                                <p><strong>Alergias a Medicamentos:</strong> ${checkin.alergiasMedicamentos === 'sim' ? 'Sim' : 'Não'}</p>
                                ${checkin.alergiasMedicamentos === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisAlergiasMedicamentos}</p>` : ''}
                                
                                <p><strong>Alergias a Insetos:</strong> ${checkin.alergiasInsetos === 'sim' ? 'Sim' : 'Não'}</p>
                                ${checkin.alergiasInsetos === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisAlergiasInsetos}</p>` : ''}
                                
                                <p><strong>Possui Seguro Saúde:</strong> ${checkin.seguroSaude ? 'Sim' : 'Não'}</p>
                                ${checkin.seguroSaude ? `<p><strong>Qual:</strong> ${checkin.seguroSaude}</p>` : ''}
                                
                                <p><strong>Hospital de Preferência:</strong> ${checkin.hospitalPreferencia || 'Não informado'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Medicamentos Controlados:</strong> ${checkin.medicamentosControlados === 'sim' ? 'Sim' : 'Não'}</p>
                                ${checkin.medicamentosControlados === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisMedicamentos}</p>` : ''}
                                
                                <p><strong>Problemas de Saúde:</strong> ${checkin.problemasSaude === 'sim' ? 'Sim' : 'Não'}</p>
                                ${checkin.problemasSaude === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisProblemasSaude}</p>` : ''}
                                
                                <p><strong>Tipo Sanguíneo:</strong> ${checkin.tipoSanguineo || 'Não informado'}</p>
                                <p><strong>Vacinas em Dia:</strong> ${checkin.vacinasEmDia === 'sim' ? 'Sim' : 'Não'}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <h5 style="border-bottom: 1px solid #dee2e6; padding-bottom: 8px;">Alimentação</h5>
                            </div>
                            <div class="col-12">
                                <p><strong>Restrições Alimentares:</strong> ${checkin.restricoesAlimentares === 'sim' ? 'Sim' : 'Não'}</p>
                                ${checkin.restricoesAlimentares === 'sim' ? `<p><strong>Quais:</strong> ${checkin.quaisRestricoesAlimentares}</p>` : ''}
                                
                                <p><strong>Alimentos que não consome:</strong> ${checkin.alimentosNaoConsome || 'Nenhum'}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <h5 style="border-bottom: 1px solid #dee2e6; padding-bottom: 8px;">Outros</h5>
                            </div>
                            <div class="col-12">
                                <p><strong>Comportamento Especial:</strong> ${checkin.comportamentoEspecial === 'sim' ? 'Sim' : 'Não'}</p>
                                ${checkin.comportamentoEspecial === 'sim' ? `<p><strong>Qual:</strong> ${checkin.qualComportamento}</p>` : ''}
                                
                                <p><strong>Observações:</strong> ${checkin.observacoesAdicionais || 'Nenhuma'}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <h5 style="border-bottom: 1px solid #dee2e6; padding-bottom: 8px;">Autorizações</h5>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Participação:</strong> ${checkin.autorizacaoParticipacao ? 'Autorizado' : 'Não autorizado'}</p>
                                <p><strong>Atendimento Médico:</strong> ${checkin.autorizacaoEmergencia ? 'Autorizado' : 'Não autorizado'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Uso de Imagem:</strong> ${checkin.autorizacaoFotos ? 'Autorizado' : 'Não autorizado'}</p>
                                <p><strong>Medicamentos Básicos:</strong> ${checkin.autorizacaoMedicamentos ? 'Autorizado' : 'Não autorizado'}</p>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <h5 style="border-bottom: 1px solid #dee2e6; padding-bottom: 8px;">Assinatura</h5>
                            </div>
                            <div class="col-12 text-center">
                                ${checkin.assinatura ?
                                `<img id="assinaturaImg" src="${checkin.assinatura}" alt="Assinatura" style="max-width: 50%; max-height: 100px;">` :
                                '<p>Assinatura não disponível</p>'}
                            </div>
                        </div>
                    </div>
                `;

                        // Criar um elemento temporário para renderizar o HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = conteudoHTML;
                        tempDiv.style.position = 'absolute';
                        tempDiv.style.left = '-9999px';
                        document.body.appendChild(tempDiv);

                        // Usar html2canvas para capturar o conteúdo
                        html2canvas(tempDiv, {
                            scale: 2, // Melhor qualidade
                            useCORS: true, // Permitir imagens de outros domínios
                            logging: false // Desativar logs
                        }).then(canvas => {
                            // Criar PDF
                            const { jsPDF } = window.jspdf;
                            const doc = new jsPDF('p', 'mm', 'a4');

                            const imgData = canvas.toDataURL('image/png');
                            const imgWidth = 190;
                            const pageHeight = 290;
                            const imgHeight = canvas.height * imgWidth / canvas.width;
                            let heightLeft = imgHeight;
                            let position = 10;

                            doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;

                            // Adicionar páginas adicionais se necessário
                            while (heightLeft >= 0) {
                                position = heightLeft - imgHeight;
                                doc.addPage();
                                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                                heightLeft -= pageHeight;
                            }

                            // Salvar o PDF
                            doc.save(`Checkin_${nomeAcampante.replace(/\s+/g, '_')}.pdf`);

                            // Remover o elemento temporário
                            document.body.removeChild(tempDiv);
                        });
                    } else {
                        alert('Detalhes do check-in não encontrados.');
                    }
                })
                .catch((error) => {
                    console.error("Erro ao exportar PDF: ", error);
                    alert('Erro ao exportar PDF.');
                });
        }

        function initGraficos() {
            // Inicializar gráfico de status
            const ctxStatus = document.getElementById('graficoStatus').getContext('2d');
            graficoStatus = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Realizados', 'Pendentes'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#6108a1', '#ffc107'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Inicializar gráfico de dias
            const ctxDias = document.getElementById('graficoDias').getContext('2d');
            graficoDias = new Chart(ctxDias, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Check-ins por Dia',
                        data: [],
                        backgroundColor: 'rgba(97, 8, 161, 0.7)',
                        borderColor: 'rgba(97, 8, 161, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function atualizarGraficoStatus(totalCheckins, totalPendentes) {
            graficoStatus.data.datasets[0].data = [totalCheckins, totalPendentes];
            graficoStatus.update();
        }

        function atualizarGraficoDias(datasPorDia) {
            const labels = Object.keys(datasPorDia).sort((a, b) => {
                const partsA = a.split('/').reverse();
                const partsB = b.split('/').reverse();
                return new Date(partsA.join('-')) - new Date(partsB.join('-'));
            });

            const dados = labels.map(data => datasPorDia[data]);

            graficoDias.data.labels = labels;
            graficoDias.data.datasets[0].data = dados;
            graficoDias.update();
        }

        function formatarData(dataString) {
            if (!dataString) return '-';

            try {
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return dataString;
            }
        }

        function formatarDataSimples(dataString) {
            if (!dataString) return '-';

            try {
                if (typeof dataString === 'string' && dataString.includes('-')) {
                    // Formato ISO
                    const partes = dataString.split('-');
                    return `${partes[2].substring(0, 2)}/${partes[1]}/${partes[0]}`;
                } else if (dataString instanceof Date) {
                    // Objeto Date
                    return dataString.toLocaleDateString('pt-BR');
                }
                return dataString;
            } catch (e) {
                return dataString;
            }
        }

        // Função para mostrar o modal de confirmação de exclusão
        function confirmarExclusao(nomeAcampante) {
            // Armazenar o nome do acampante no modal
            $('#nomeAcampanteExclusao').text(nomeAcampante);
            
            // Configurar o botão de confirmação
            $('#confirmarExclusaoBtn').off('click').on('click', function() {
                excluirCheckin(nomeAcampante);
            });
            
            // Mostrar o modal
            $('#confirmarExclusaoModal').modal('show');
        }

        // Função para excluir o check-in
        function excluirCheckin(nomeAcampante) {
            // Mostrar indicador de carregamento
            $('#confirmarExclusaoBtn').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Excluindo...');
            $('#confirmarExclusaoBtn').prop('disabled', true);
            
            // 1. Buscar o documento de check-in para excluir
            db.collection("Eventos").doc("ComRoca2025").collection("checkin")
                .where("nome", "==", nomeAcampante)
                .get()
                .then((querySnapshot) => {
                    // Array de promessas para exclusão
                    const deletePromises = [];
            
                    querySnapshot.forEach((doc) => {
                        // Adicionar promessa de exclusão ao array
                        deletePromises.push(doc.ref.delete());
                    });
            
                    // 2. Atualizar o status na coleção de inscrições
                    const updatePromise = db.collection("Eventos").doc("ComRoca2025").collection("inscricoes")
                        .where("nome", "==", nomeAcampante)
                        .where("anoevento", "==", "2025")
                        .get()
                        .then((inscricoesSnapshot) => {
                            const inscricoesPromises = [];
                    
                            inscricoesSnapshot.forEach((doc) => {
                                // Remover campos relacionados ao check-in
                                inscricoesPromises.push(doc.ref.update({
                                    statusCheckin: firebase.firestore.FieldValue.delete(),
                                    dtCheckin: firebase.firestore.FieldValue.delete()
                                }));
                            });
                    
                            return Promise.all(inscricoesPromises);
                        });
            
                    // Executar todas as promessas
                    return Promise.all([...deletePromises, updatePromise]);
                })
                .then(() => {
                    // Fechar o modal
                    $('#confirmarExclusaoModal').modal('hide');
            
                    // Mostrar mensagem de sucesso
                    alert('Check-in excluído com sucesso!');
            
                    // Recarregar os dados
                    carregarDashboard();
                    carregarCheckins();
                })
                .catch((error) => {
                    console.error("Erro ao excluir check-in:", error);
                    alert('Erro ao excluir check-in. Por favor, tente novamente.');
            
                    // Restaurar botão
                    $('#confirmarExclusaoBtn').html('Excluir Check-in');
                    $('#confirmarExclusaoBtn').prop('disabled', false);
                });
        }
    </script>
</body>

</html>